<!DOCTYPE html>
<html>
<head><title>Driver vroom vroom</title></head>
<body>
  <div id="homeScreen" style="display:block">  
      <h2>Welcome. Press the button to begin searching for riders.</h2>
      <!-- <input type="text" id="destination" placeholder="Destination"> -->
      <button onclick="searchRiders()">Search for Riders</button>
  </div>
  <div id="searchScreen" style="display:none">  
      <h2>Searching for riders...</h2>
      <!-- <input type="text" id="destination" placeholder="Destination"> -->
      <button onclick="cancelSearch()">Cancel Search</button>
  </div>

  <div id="bookingList"></div>

    <div id="confirmationBox" style="display:none;">
      <h2>Enter confirmation code from the rider.</h2>
    <input type="text" id="confirmCode" placeholder="Enter confirmation code">
    <button onclick="verifyCode()">Verify</button>
  </div>


  <p id="status"></p> <!-- This is where the message will appear -->

  <script>
    let poll;
    let rejectedBookings = new Set(); // Track rejected IDs
    let acceptedBooking;
    const username = new URLSearchParams(window.location.search).get("username");

    function searchRiders() {
      // Every 3 seconds, search the booking table for any pending riders that have not been shown to us before.
      // Also give us a cancel button to return to the initial state of not searching.
      // If one shows up, show it to us, and we can either accept or decline.
      // If decline, save that booking ID so we don't have to repeat it.
      // If accept, show an input prompt and button that awaits the confirmation code, as well as a cancel button.
      // Once the confirmation code is added, a ride is created.
      // The driver can cancel or complete the ride. The rider can cancel.
        //const username = new URLSearchParams(window.location.search).get("username");
        //const pickup = document.getElementById("pickup").value;
        //const destination = document.getElementById("destination").value;

        document.getElementById("homeScreen").style.display = "none";
        document.getElementById("searchScreen").style.display = "block";
      
        // set driver search_status to "searching"
        updateDriverStatus("searching");

        poll = setInterval(() => {
        fetch("/searchRider", {method:"GET"})
            .then(res => res.json()) //This should either give nothing, or the booking ID found.
            .then(data => {
            if (data.status === "found" && Array.isArray(data.bookings)) {
              data.bookings.forEach(booking => {
                const bookingId = booking.bookingId;

                // Skip if already rejected
                if (rejectedBookings.has(bookingId)) return;

                // Add booking to the list
                addBooking(bookingId, booking.pickup, booking.destination);



              });
        }});
        }, 3000) // poll every 3 seconds

          .catch(err => {
              document.getElementById("status").innerText = "Error find rider.";
              console.error(err);
      });
    }

    function revertToOldLayout() {
      pass
    }

    function addBooking(bookingId, pickup, destination) {
      let bookingList = document.getElementById("bookingList");

      let newBooking = document.createElement("div");
      newBooking.id = "booking_" + bookingId;
      newBooking.innerHTML = `
        <p>Booking #${bookingId}: ${pickup} -> ${destination}</p>
        <button onclick="acceptBooking('${bookingId}')">Accept</button>
        <button onclick="rejectBooking('${bookingId}')">Reject</button>
      `;

      bookingList.appendChild(newBooking);

      rejectedBookings.add(bookingId);
    }

    function acceptBooking(bookingId) {
      fetch("/acceptBooking", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookingId }) //Given this body, change the status of the booking with this bookingID to "accepted"
      });

      clearInterval(poll);

      acceptedBooking = bookingId;

      updateDriverStatus("driving");

      document.getElementById("bookingList").innerHTML = "";
      document.getElementById("searchScreen").style.display = "none";
      document.getElementById("confirmationBox").style.display = "block";
    }

    function rejectBooking(bookingId) {
      rejectedBookings.add(bookingId); //Remember all rejected bookingId's
      document.getElementById("booking_" + bookingId).remove();
    }

    function cancelSearch() {
      clearInterval(poll);
      document.getElementById("status").innerText = "Searching was cancelled.";
      rejectedBookings = new Set();
      updateDriverStatus("standby");
      document.getElementById("homeScreen").style.display = "block";
      document.getElementById("searchScreen").style.display = "home";
    }

    function updateDriverStatus(search_status) {
      fetch("/updateDriverStatus", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: username,   // however you track the logged-in driver
          search_status: search_status
        })
      })
    }



  </script>
</body>
</html>